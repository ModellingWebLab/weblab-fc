<?xml version="1.0"?>
<?xml-model href="../parsing/protocol.rnc" type="application/relax-ng-compact-syntax"?>
<!--
    Library of routines useful for post-processing cardiac simulations.
-->
<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#">
    <library>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!--
                Return that portion of an input array that occurs strictly after a specified time
                (although the comparison array does not necessarily have to be time).
            -->
            <apply><eq/>
                <ci>after</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>index</ci></bvar>
                    <bvar><ci>test_value</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- Test arguments -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply><ci>default_dim</ci>
                                <ci>array</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                <ci>index</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                <ci>test_value</ci>
                            </apply>
                        </apply>
                        <!-- Compute result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/index"/>
                                <ci>array</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/find"/>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                        <lambda>
                                            <bvar><ci>idx_value</ci></bvar>
                                            <apply><gt/>
                                                <ci>idx_value</ci>
                                                <ci>test_value</ci>
                                            </apply>
                                        </lambda>
                                        <ci>index</ci>
                                    </apply>
                                </apply>
                                <ci>dim</ci>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- Remove the given dimension from an array, taking a slice at the 0th entry -->
            <apply><eq/>
                <ci>remove_dim</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>dim</ci></bvar>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                        <ci>array</ci>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                            <ci>dim</ci><cn>0</cn><cn>0</cn><cn>0</cn>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                            <cn>1</cn>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- Add a new dimension to an array, of extent 1 -->
            <apply><eq/>
                <ci>add_dim</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>dim</ci></bvar>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                        <domainofapplication>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                <ci>dim</ci><cn>0</cn><cn>1</cn><cn>1</cn>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">_</csymbol>
                            </apply>
                        </domainofapplication>
                        <ci>array</ci>
                    </apply>
                </lambda>
            </apply>

            <!-- localise(fn, array, windowSize, dim=default):
                Perform a function locally within a given window size, for example to compute the local
                maxima of an array centered at each entry.
                The function must take two arguments: an array, and dimension.
            -->
            <apply><eq/>
                <ci>localise</ci>
                <lambda>
                    <bvar><ci>fn</ci></bvar>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>windowSize</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- Test arguments -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply><ci>default_dim</ci>
                                <ci>array</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- Compute result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply><ci>remove_dim</ci>
                                <apply><ci>fn</ci>
                                    <apply><ci>window</ci>
                                        <ci>array</ci>
                                        <ci>windowSize</ci>
                                        <ci>dim</ci>
                                    </apply>
                                    <cn>0</cn>
                                </apply>
                                <cn>0</cn>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- apd(V, t, percent=90.0, dim=default, dvdtThreshold=10.0, windowSize=50)
                Compute action potential durations and diastolic intervals along timeseries.
                Returns a tuple (apd, di).
                
                TODO: check whether we handle a non-default dim properly!
            -->
            <apply><eq/>
                <ci>apd</ci>
                <lambda>
                    <bvar><ci>V</ci></bvar>
                    <bvar><ci>t</ci></bvar>
                    <semantics>
                        <bvar><ci>percent</ci></bvar>
                        <annotation-xml>
                            <cn>90.0</cn>
                        </annotation-xml>
                    </semantics>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <semantics>
                        <bvar><ci>dvdtThreshold</ci></bvar>
                        <annotation-xml>
                            <cn>10.0</cn>
                        </annotation-xml>
                    </semantics>
                    <semantics>
                        <bvar><ci>windowSize</ci></bvar>
                        <annotation-xml>
                            <cn>50</cn>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- Test arguments -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply><ci>default_dim</ci>
                                <ci>V</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <ci>shape_eq</ci>
                                <ci>V</ci>
                                <ci>t</ci>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>num_dims</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                <ci>V</ci>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>input_shape</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                <ci>V</ci>
                            </apply>
                        </apply>
                        <!-- Check percent -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                <ci>percent</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><leq/>
                                <ci>percent</ci>
                                <cn>100</cn>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><geq/>
                                <ci>percent</ci>
                                <cn>0</cn>
                            </apply>
                        </apply>
                        <!-- Check dvdtThreshold & windowSize -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                <ci>dvdtThreshold</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                <ci>windowSize</ci>
                            </apply>
                        </apply>
                        
                        <!-- Compute result -->
                        <!-- Find the maximum upstroke velocity location -->
                        <apply><eq/>
                            <ci>dVdt</ci>
                            <apply><ci>grad</ci>
                                <ci>t</ci>
                                <ci>V</ci>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <!-- Ensure dV/dt crosses the threshold, so we have a chance of having an AP -->
                        <apply><csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><and/>
                                <apply><lt/>
                                    <apply><ci>multi_fold</ci>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">min</csymbol>
                                        <ci>dVdt</ci>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                    </apply>
                                    <ci>dvdtThreshold</ci>
                                </apply>
                                <apply><gt/>
                                    <apply><ci>multi_fold</ci>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">max</csymbol>
                                        <ci>dVdt</ci>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                    </apply>
                                    <ci>dvdtThreshold</ci>
                                </apply>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>max_upstroke_idxs</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/find"/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                    <lambda>
                                        <bvar><ci>slope</ci></bvar>
                                        <bvar><ci>max_slope</ci></bvar>
                                        <apply><and/>
                                            <apply><eq/>
                                                <ci>slope</ci><ci>max_slope</ci>
                                            </apply>
                                            <apply><gt/>
                                                <ci>slope</ci><ci>dvdtThreshold</ci>
                                            </apply>
                                        </apply>
                                    </lambda>
                                    <ci>dVdt</ci>
                                    <apply><ci>localise</ci>
                                        <ci>max</ci>
                                        <ci>dVdt</ci>
                                        <ci>windowSize</ci>
                                        <ci>dim</ci>
                                    </apply>
                                </apply>
                            </apply>
                        </apply>
                        
                        <!--
                            Get the max upstroke times as an extended array 'N'xAxT, where N is #runs, A is max #APs, T is #time steps.
                            But N may represent multiple dimensions, if NUM_DIMS > 2, or none if NUM_DIMS==1.
                        -->
                        <apply><eq/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                <ci>extended_shape</ci>
                                <ci>max_upstroke_times</ci>
                            </apply>
                            <apply>
                                <lambda>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                                        <!--
                                            If one trace has fewer APs, we need to extend it.  To do so, we need to fake extra APs for this trace.
                                            We do so by 'copying' the first AP of the first trace; it should generally work OK.
                                        -->
                                        <apply><eq/>
                                            <ci>fake_upstroke_time</ci>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/index"/>
                                                    <ci>t</ci>
                                                    <ci>max_upstroke_idxs</ci>
                                                    <ci>dim</ci>
                                                    <cn>1</cn>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                                </apply>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                    <cn>0</cn><cn>0</cn><cn>0</cn><cn>0</cn>
                                                </apply>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                    <cn>0</cn><cn>0</cn><cn>0</cn>
                                                </apply>
                                            </apply>
                                        </apply>
                                        <apply><eq/>
                                            <ci>times_nonextended</ci>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/index"/>
                                                <ci>t</ci>
                                                <ci>max_upstroke_idxs</ci>
                                                <ci>dim</ci>
                                                <cn>0</cn>
                                                <cn>1</cn>
                                                <ci>fake_upstroke_time</ci>
                                            </apply>
                                        </apply>
                                        <apply><eq/>
                                            <!-- Add in the A dimension as the last-but-one -->
                                            <ci>extended_shape</ci>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                                                <domainofapplication>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <cn>0</cn>
                                                        <cn>0</cn>
                                                        <cn>1</cn>
                                                        <apply><plus/><ci>num_dims</ci><cn>1</cn></apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">i</csymbol>
                                                    </apply>                                                    
                                                </domainofapplication>
                                                <piecewise>
                                                    <piece>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                            <ci>input_shape</ci>
                                                            <apply>
                                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                                <cn>0</cn>
                                                                <apply><minus/><ci>i</ci><cn>1</cn></apply>
                                                                <cn>0</cn>
                                                                <apply><minus/><ci>i</ci><cn>1</cn></apply>
                                                            </apply>
                                                        </apply>
                                                        <apply><eq/><ci>i</ci><ci>num_dims</ci></apply>
                                                    </piece>
                                                    <otherwise>
                                                        <piecewise>
                                                            <piece>
                                                                <apply>
                                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                                    <apply>
                                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                                                        <ci>times_nonextended</ci>
                                                                    </apply>
                                                                    <apply>
                                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                                        <cn>0</cn>
                                                                        <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                                                                        <cn>0</cn>
                                                                        <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                                                                    </apply>
                                                                </apply>                                                                
                                                                <apply><eq/><ci>i</ci><apply><minus/><ci>num_dims</ci><cn>1</cn></apply></apply>
                                                            </piece>
                                                            <otherwise>
                                                                <apply>
                                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                                    <ci>input_shape</ci>
                                                                    <apply>
                                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                                        <cn>0</cn>
                                                                        <ci>i</ci>
                                                                        <cn>0</cn>
                                                                        <ci>i</ci>
                                                                    </apply>
                                                                </apply>
                                                            </otherwise>
                                                        </piecewise>
                                                    </otherwise>
                                                </piecewise>
                                            </apply>
                                        </apply>
                                        <apply><eq/>
                                            <ci>max_upstroke_times</ci>
                                            <apply><ci>stretch</ci>
                                                <apply><ci>add_dim</ci>
                                                    <ci>times_nonextended</ci>
                                                    <ci>num_dims</ci>
                                                </apply>
                                                <ci>extended_shape</ci>
                                                <ci>num_dims</ci>
                                            </apply>
                                        </apply>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <ci>extended_shape</ci>
                                                <ci>max_upstroke_times</ci>
                                            </apply>
                                        </apply>
                                    </apply>
                                </lambda>
                            </apply>
                        </apply>
                    
                        <!-- Find the peaks of these APs: V == local_Vmax && t > t_up -->
                        <apply><eq/>
                            <ci>local_Vmax</ci>
                            <apply><ci>stretch</ci>
                                <apply><ci>add_dim</ci>
                                    <apply><ci>localise</ci>
                                        <ci>max</ci>
                                        <ci>V</ci>
                                        <cn>1</cn>
                                        <ci>dim</ci>
                                    </apply>
                                    <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                                </apply>
                                <ci>extended_shape</ci>
                                <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>extended_V</ci>
                            <apply><ci>stretch</ci>
                                <apply><ci>add_dim</ci>
                                    <ci>V</ci>
                                    <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                                </apply>
                                <ci>extended_shape</ci>
                                <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>extended_time</ci>
                            <apply><ci>stretch</ci>
                                <apply><ci>add_dim</ci>
                                    <ci>t</ci>
                                    <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                                </apply>
                                <ci>extended_shape</ci>
                                <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>peak_idxs</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/find"/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                    <lambda>
                                        <bvar><ci>V</ci></bvar>
                                        <bvar><ci>Vmax</ci></bvar>
                                        <bvar><ci>t</ci></bvar>
                                        <bvar><ci>t_up</ci></bvar>
                                        <apply><and/>
                                            <apply><eq/><ci>V</ci><ci>Vmax</ci></apply>
                                            <apply><gt/><ci>t</ci><ci>t_up</ci></apply>
                                        </apply>
                                    </lambda>
                                    <ci>extended_V</ci>
                                    <ci>local_Vmax</ci>
                                    <ci>extended_time</ci>
                                    <ci>max_upstroke_times</ci>
                                </apply>
                            </apply>
                        </apply>
                        <!-- Take the first such t & V -->
                        <apply><eq/>
                            <ci>t_peak</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/index"/>
                                    <ci>extended_time</ci>
                                    <ci>peak_idxs</ci>
                                    <ci>num_dims</ci>
                                    <cn>1</cn>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                    <ci>num_dims</ci><cn>0</cn><cn>1</cn><cn>1</cn>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    <cn>1</cn>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                </apply>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>V_peak</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/index"/>
                                    <ci>extended_V</ci>
                                    <ci>peak_idxs</ci>
                                    <ci>num_dims</ci>
                                    <cn>1</cn>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                    <ci>num_dims</ci><cn>0</cn><cn>1</cn><cn>1</cn>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    <cn>1</cn>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                </apply>
                            </apply>
                        </apply>

                        <!-- Assume resting potential is global minimum, and calculate relaxation potential -->
                        <apply><eq/>
                            <ci>V_rest</ci>
                            <apply><ci>min</ci>
                                <ci>extended_V</ci>
                                <ci>num_dims</ci>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>V_relax</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <lambda>
                                    <!-- V_rest + (1-percent/100.0)*(V_peak-V_rest) -->
                                    <bvar><ci>V_peak</ci></bvar>
                                    <bvar><ci>V_rest</ci></bvar>
                                    <apply><plus/>
                                        <ci>V_rest</ci>
                                        <apply><times/>
                                            <apply><minus/>
                                                <cn>1</cn>
                                                <apply><divide/><ci>percent</ci><cn>100</cn></apply>
                                            </apply>
                                            <apply><minus/>
                                                <ci>V_peak</ci><ci>V_rest</ci>
                                            </apply>
                                        </apply>
                                    </apply>
                                </lambda>
                                <ci>V_peak</ci>
                                <ci>V_rest</ci>
                            </apply>
                        </apply>
                        
                        <!-- Find (with interpolation) the first time before each peak where the relaxation potential is crossed -->
                        <apply><eq/>
                            <ci>t_ap_starts</ci>
                            <apply><ci>remove_dim</ci>
                                <apply><ci>interp</ci>
                                    <ci>extended_time</ci>
                                    <ci>extended_V</ci>
                                    <ci>V_relax</ci>
                                    <ci>t_peak</ci>
                                    <cn>0</cn>
                                    <ci>num_dims</ci>
                                </apply>
                                <ci>num_dims</ci>
                            </apply>
                        </apply>
                        <!-- Check we have at least 2 -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><geq/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                        <ci>t_ap_starts</ci>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <cn>0</cn>
                                        <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                                        <cn>0</cn>
                                        <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                                    </apply>
                                </apply>
                                <cn>2</cn>
                            </apply>
                        </apply>
                        <!-- Similarly, find the first time after each peak, and compute the difference -->
                        <apply><eq/>
                            <ci>t_ap_ends</ci>
                            <apply><ci>remove_dim</ci>
                                <apply><ci>interp</ci>
                                    <ci>extended_time</ci>
                                    <ci>extended_V</ci>
                                    <ci>V_relax</ci>
                                    <ci>t_peak</ci>
                                    <cn>1</cn>
                                    <ci>num_dims</ci>
                                </apply>
                                <ci>num_dims</ci>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>apds</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">minus</csymbol>
                                <ci>t_ap_ends</ci>
                                <ci>t_ap_starts</ci>
                            </apply>
                        </apply>
                    
                        <!-- DI = diff(t_ap_starts) - apds[:-1] -->
                        <apply><eq/>
                            <ci>dis</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">minus</csymbol>
                                <apply><ci>diff</ci>
                                    <ci>t_ap_starts</ci>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>apds</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <apply><minus/><ci>num_dims</ci><cn>1</cn></apply>
                                        <cn>0</cn>
                                        <cn>1</cn>
                                        <cn>-1</cn>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                            </apply>
                        </apply>
                        <!-- Return results -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                <ci>apds</ci>
                                <ci>dis</ci>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
        </apply>
    </library>
</protocol>
