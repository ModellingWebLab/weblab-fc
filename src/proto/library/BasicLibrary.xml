<?xml version="1.0"?>
<?xml-model href="../parsing/protocol.rnc" type="application/relax-ng-compact-syntax"?>
<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#">
    <library>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!-- max = lambda a, dim=default: fold(mathml.max, a, default, dim) -->
            <apply><eq/>
                <ci>max</ci>
                <lambda>
                    <bvar><ci>a</ci></bvar>
                    <semantics>
                        <bvar><ci>dim</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/fold"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">max</csymbol>
                        <ci>a</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        <ci>dim</ci>
                    </apply>
                </lambda>
            </apply>

            <!-- min = lambda a, dim=default: fold(mathml.min, a, default, dim) -->
            <apply><eq/>
                <ci>min</ci>
                <lambda>
                    <bvar><ci>a</ci></bvar>
                    <semantics>
                        <bvar><ci>dim</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/fold"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">min</csymbol>
                        <ci>a</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        <ci>dim</ci>
                    </apply>
                </lambda>
            </apply>
            
            <!-- default_dim(array, dim'): if dim'=default then array.num_dims-1 else dim' -->
            <apply><eq/>
                <ci>default_dim</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>dim'</ci></bvar>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                <ci>array</ci>
                            </apply>
                        </apply>
                        <!-- calculate result -->
                        <apply><eq/>
                            <ci>default_dim</ci>
                            <apply><minus/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                    <ci>array</ci>
                                </apply>
                                <cn>1</cn>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>dim</ci>
                            <piecewise>
                                <piece>
                                    <ci>default_dim</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_DEFAULT</csymbol>
                                        <ci>dim'</ci>
                                    </apply>
                                </piece>
                                <otherwise>
                                    <ci>dim'</ci>
                                </otherwise>
                            </piecewise>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><lt/>
                                <ci>dim</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                    <ci>array</ci>
                                </apply>
                            </apply>
                        </apply>
                        <!-- return result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <ci>dim</ci>
                        </apply>
                    </apply>
                </lambda>
            </apply>
                        
            <!--
                def diff(array, dim=array.num_dims-1):
                    map(-, array[<dim>1:], array[<dim>:-1])
            -->
            <apply><eq/>
                <ci>diff</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments using default_dim -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply>
                                <ci>default_dim</ci>
                                <ci>array</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">minus</csymbol>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>array</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>1</cn>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>array</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <cn>1</cn>
                                        <cn>-1</cn>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- grad x y [dim] = map (/) (diff y dim) (diff x dim) -->
            <apply><eq/>
                <ci>grad</ci>
                <lambda>
                    <bvar><ci>x</ci></bvar>
                    <bvar><ci>y</ci></bvar>
                    <semantics>
                        <bvar><ci>dim</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">divide</csymbol>
                        <apply>
                            <ci>diff</ci>
                            <ci>y</ci>
                            <ci>dim</ci>
                        </apply>
                        <apply>
                            <ci>diff</ci>
                            <ci>x</ci>
                            <ci>dim</ci>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- join(a1, a2, dim=default): catenate two arrays along the given dimension -->
            <apply><eq/>
                <ci>join</ci>
                <lambda>
                    <bvar><ci>a1</ci></bvar>
                    <bvar><ci>a2</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test some arguments using default_dim -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply>
                                <ci>default_dim</ci>
                                <ci>a1</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- the array comprehension will check that a1.num_dims == a2.num_dims, and that the shapes match up -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                                <domainofapplication>
                                    <!-- #dim#i=-a1.shape[dim]:a2.shape[dim] -->
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <apply><minus/>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                                    <ci>a1</ci>
                                                </apply>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                    <cn>0</cn>
                                                    <ci>dim</ci>
                                                    <cn>0</cn>
                                                    <ci>dim</ci>
                                                </apply>
                                            </apply>
                                        </apply>
                                        <cn>1</cn>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                                <ci>a2</ci>
                                            </apply>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <cn>0</cn>
                                                <ci>dim</ci>
                                                <cn>0</cn>
                                                <ci>dim</ci>
                                            </apply>
                                        </apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">i</csymbol>
                                    </apply>
                                </domainofapplication>
                                <!-- If the index along dim is less than zero, use a slice of a1, else a slice of a2 -->
                                <piecewise>
                                    <piece>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                            <ci>a1</ci>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <ci>dim</ci>
                                                <ci>i</ci>
                                                <cn>0</cn>
                                                <ci>i</ci>
                                            </apply>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                <cn>1</cn>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                            </apply>
                                        </apply>
                                        <apply><lt/><ci>i</ci><cn>0</cn></apply>
                                    </piece>
                                    <otherwise>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                            <ci>a2</ci>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <ci>dim</ci>
                                                <ci>i</ci>
                                                <cn>0</cn>
                                                <ci>i</ci>
                                            </apply>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                <cn>1</cn>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                            </apply>
                                        </apply>
                                    </otherwise>
                                </piecewise>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!--
                stretch(array, length_spec, dim=default): stretch dimension dim (of length 1) to the given length.
                The length_spec can either be a number giving the length, or a shape array the relevant entry of
                which will be read.  We do not (yet) check that the other dimensions match the input array shape!
            -->
            <apply><eq/>
                <ci>stretch</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>length_spec</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- some testing of arguments using default_dim -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply>
                                <ci>default_dim</ci>
                                <ci>array</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- Figure out the desired length -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><or/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                    <ci>length_spec</ci>
                                </apply>
                                <apply><and/>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                        <ci>length_spec</ci>
                                    </apply>
                                    <apply><eq/>
                                        <!-- length_spec.num_dims == 1 -->
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                            <ci>length_spec</ci>
                                        </apply>
                                        <cn>1</cn>
                                    </apply>
                                    <apply><eq/>
                                        <!-- Check that length_spec.shape[0] == array.num_dims -->
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                                <ci>length_spec</ci>
                                            </apply>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <cn>0</cn>
                                                <cn>0</cn>
                                                <cn>0</cn>
                                                <cn>0</cn>
                                            </apply>
                                        </apply>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                            <ci>array</ci>
                                        </apply>
                                    </apply>
                                </apply>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>length</ci>
                            <piecewise>
                                <piece>
                                    <!-- length_spec is just a number so use it -->
                                    <ci>length_spec</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                        <ci>length_spec</ci>
                                    </apply>
                                </piece>
                                <otherwise>
                                    <!-- length_spec is a shape array so index it -->
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                        <ci>length_spec</ci>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                            <cn>0</cn>
                                            <ci>dim</ci>
                                            <cn>0</cn>
                                            <ci>dim</ci>
                                        </apply>
                                    </apply>
                                </otherwise>
                            </piecewise>
                        </apply>
                        <!-- Also check that the array.shape[dim] == 1 -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><eq/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                        <ci>array</ci>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <cn>0</cn>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <ci>dim</ci>
                                    </apply>
                                </apply>
                                <cn>1</cn>
                            </apply>
                        </apply>
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                                <domainofapplication>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <cn>1</cn>
                                        <ci>length</ci>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">i</csymbol>
                                    </apply>
                                </domainofapplication>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>array</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <cn>0</cn>
                                        <cn>0</cn>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- shift(array, distance, dim=default) -->
            <apply><eq/>
                <ci>shift</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>distance</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments using default_dim -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply>
                                <ci>default_dim</ci>
                                <ci>array</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <piecewise>
                                <piece>
                                    <!-- no-op if distance == 0 -->
                                    <ci>array</ci>
                                    <apply><eq/><ci>distance</ci><cn>0</cn></apply>
                                </piece>
                                <otherwise>
                                    <piecewise>
                                        <piece>
                                            <!-- shift right if distance > 0:
                                                join stretch(array[<dim>0:1], distance, dim)
                                                   & array[<dim>0:-distance] along dim -->
                                            <apply>
                                                <ci>join</ci>
                                                <apply>
                                                    <ci>stretch</ci>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                        <ci>array</ci>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                            <ci>dim</ci>
                                                            <cn>0</cn>
                                                            <cn>1</cn>
                                                            <cn>1</cn>
                                                        </apply>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                            <cn>1</cn>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        </apply>
                                                    </apply>
                                                    <ci>distance</ci>
                                                    <ci>dim</ci>
                                                </apply>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                    <ci>array</ci>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <ci>dim</ci>
                                                        <cn>0</cn>
                                                        <cn>1</cn>
                                                        <apply><minus/><ci>distance</ci></apply>
                                                    </apply>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        <cn>1</cn>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                    </apply>
                                                </apply>
                                                <ci>dim</ci>
                                            </apply>
                                            <apply><gt/><ci>distance</ci><cn>0</cn></apply>
                                        </piece>
                                        <otherwise>
                                            <!-- shift left if distance < 0:
                                                join array[<dim>-distance:]
                                                   & stretch(array[<dim>-1:], -distance, dim) along dim -->
                                            <apply>
                                                <ci>join</ci>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                    <ci>array</ci>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <ci>dim</ci>
                                                        <apply><minus/><ci>distance</ci></apply>
                                                        <cn>1</cn>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                    </apply>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        <cn>1</cn>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                    </apply>
                                                </apply>
                                                <apply>
                                                    <ci>stretch</ci>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                        <ci>array</ci>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                            <ci>dim</ci>
                                                            <cn>-1</cn>
                                                            <cn>1</cn>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        </apply>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                            <cn>1</cn>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        </apply>
                                                    </apply>
                                                    <apply><minus/><ci>distance</ci></apply>
                                                    <ci>dim</ci>
                                                </apply>
                                                <ci>dim</ci>
                                            </apply>
                                        </otherwise>
                                    </piecewise>
                                </otherwise>
                            </piecewise>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- window(array, size, dim=default) -->
            <apply><eq/>
                <ci>window</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>size</ci></bvar>
                    <semantics>
                        <bvar><ci>dim</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                <ci>array</ci>
                            </apply>
                        </apply>
                        
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                                <domainofapplication>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <cn>0</cn> <!-- dim -->
                                        <apply><minus/><ci>size</ci></apply> <!-- start -->
                                        <cn>1</cn> <!-- stride -->
                                        <apply><plus/><ci>size</ci><cn>1</cn></apply> <!-- end -->
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">i</csymbol> <!-- var name -->
                                    </apply>
                                </domainofapplication>
                                <apply>
                                    <ci>shift</ci>
                                    <ci>array</ci>
                                    <ci>i</ci>
                                    <ci>dim</ci>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- Recursive function to fold along every dimension in turn, starting from zero -->
            <apply><eq/>
                <ci>multi_fold</ci>
                <lambda>
                    <bvar><ci>op</ci></bvar>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>init</ci></bvar>
                    <piecewise>
                        <piece>
                            <!-- Base case: 0d input - return the single value -->
                            <ci>array</ci>
                            <apply><eq/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                    <ci>array</ci>
                                </apply>
                                <cn>0</cn>
                            </apply>
                        </piece>
                        <otherwise>
                            <!-- Recursive case: fold zeroth dimension -->
                            <apply>
                                <ci>multi_fold</ci>
                                <ci>op</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/fold"/>
                                        <ci>op</ci>
                                        <ci>array</ci>
                                        <ci>init</ci>
                                        <cn>0</cn>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <cn>0</cn> <!-- dim -->
                                        <cn>0</cn> <!-- start -->
                                        <cn>0</cn> <!-- stride -->
                                        <cn>0</cn> <!-- end -->
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                                <ci>init</ci>
                            </apply>                            
                        </otherwise>
                    </piecewise>
                </lambda>
            </apply>

            <!-- Function to check array equality elementwise.
                Works with arrays of any dimension.
                Implemented as multi_fold(and, map(eq, a1, a2), true) -->
            <apply><eq/>
                <ci>array_eq</ci>
                <lambda>
                    <bvar><ci>a1</ci></bvar>
                    <bvar><ci>a2</ci></bvar>
                    <apply>
                        <ci>multi_fold</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">and</csymbol>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">eq</csymbol>
                            <ci>a1</ci>
                            <ci>a2</ci>
                        </apply>
                        <cn>1</cn>
                    </apply>
                </lambda>
            </apply>
            
            <!-- Check whether two arrays have the same shape -->
            <apply><eq/>
                <ci>shape_eq</ci>
                <lambda>
                    <bvar><ci>a1</ci></bvar>
                    <bvar><ci>a2</ci></bvar>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                <ci>a1</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                <ci>a2</ci>
                            </apply>
                        </apply>                        
                        <!-- return result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply><ci>array_eq</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                    <ci>a1</ci>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                    <ci>a2</ci>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- interp(xs, ys, targets, starts, afterStarts=1, dim=default): linear interpolation
              It uses the following algorithm:
                interp xs ys y
                  = let pred = if ys[0] < y  # ys increasing
                               then (>=y)  # lambda v: v >= y
                               else (<=y)  # lambda v: v <= y
                    in let i = (find (pred ys))[0]  # Error if pred never satisfied
                       in if i == 0
                          then xs[i]
                          else xs[i-1] + (xs[i]-xs[i-1])*(y-ys[i-1])/(ys[i]-ys[i-1])
            -->
            <apply><eq/>
                <ci>interp</ci>
                <lambda>
                    <bvar><ci>xs</ci></bvar>
                    <bvar><ci>ys</ci></bvar>
                    <bvar><ci>targets</ci></bvar>
                    <bvar><ci>starts</ci></bvar>
                    <semantics>
                        <bvar><ci>afterStarts</ci></bvar>
                        <annotation-xml>
                            <cn>1</cn>
                        </annotation-xml>
                    </semantics>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- check arguments -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply><ci>default_dim</ci>
                                <ci>xs</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>input_shape</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                <ci>xs</ci>
                            </apply>                            
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><ci>array_eq</ci>
                                <ci>input_shape</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                    <ci>ys</ci>
                                </apply>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>result_shape</ci>
                            <!-- 1 for the desired dimension, input shape otherwise -->
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                                <domainofapplication>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <cn>0</cn><cn>0</cn><cn>1</cn>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                            <ci>xs</ci>
                                        </apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">i</csymbol>
                                    </apply>
                                </domainofapplication>
                                <piecewise>
                                    <piece>
                                        <cn>1</cn>
                                        <apply><eq/><ci>i</ci><ci>dim</ci></apply>
                                    </piece>
                                    <otherwise>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                            <ci>input_shape</ci>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <cn>0</cn><ci>i</ci><cn>0</cn><ci>i</ci>
                                            </apply>
                                        </apply>
                                    </otherwise>
                                </piecewise>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><ci>array_eq</ci>
                                <ci>result_shape</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                    <ci>starts</ci>
                                </apply>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><ci>array_eq</ci>
                                <ci>result_shape</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                    <ci>targets</ci>
                                </apply>
                            </apply>
                        </apply>
                        
                        <!-- Result calculation -->
                        <apply><eq/>
                            <ci>stretched_starts</ci>
                            <apply><ci>stretch</ci>
                                <ci>starts</ci>
                                <ci>input_shape</ci>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>stretched_targets</ci>
                            <apply><ci>stretch</ci>
                                <ci>targets</ci>
                                <ci>input_shape</ci>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <!--
                            We want to find indexes i into rYs such that rXs[i] >= p_stretched_starts[i], and
                            if rYs[start] > rTargets, rYs[i] <= p_stretched_targets[i]
                            if rYs[start] < rTargets, rYs[i] >= p_stretched_targets[i]
                        -->
                        <!-- First, find the values of y where x=start -->
                        <apply><eq/>
                            <ci>y_starts</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/index"/>
                                <ci>ys</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/find"/>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">eq</csymbol>
                                        <ci>xs</ci>
                                        <ci>stretched_starts</ci>
                                    </apply>
                                </apply>
                                <ci>dim</ci>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                            </apply>
                        </apply>
                        <!-- Next, create an array saying whether Y is increasing or decreasing in the region of interest -->
                        <apply><eq/>
                            <ci>increasing</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">lt</csymbol>
                                <ci>y_starts</ci>
                                <ci>targets</ci>
                            </apply>
                        </apply>
                        <!-- Now, test for Y matching the predicate -->
                        <apply><eq/>
                            <ci>y_matches</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <lambda>
                                    <bvar><ci>inc</ci></bvar>
                                    <bvar><ci>y</ci></bvar>
                                    <bvar><ci>t</ci></bvar>
                                    <piecewise>
                                        <piece>
                                            <apply><geq/><ci>y</ci><ci>t</ci></apply>
                                            <ci>inc</ci>
                                        </piece>
                                        <otherwise>
                                            <apply><leq/><ci>y</ci><ci>t</ci></apply>
                                        </otherwise>
                                    </piecewise>
                                </lambda>
                                <apply><ci>stretch</ci>
                                    <ci>increasing</ci>
                                    <ci>input_shape</ci>
                                    <ci>dim</ci>
                                </apply>
                                <ci>ys</ci>
                                <ci>stretched_targets</ci>
                            </apply>
                        </apply>
                        <!-- Finally, filter so we only get matches before/after the start point -->
                        <apply><eq/>
                            <ci>idxs</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/find"/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                    <piecewise>
                                        <piece>
                                            <lambda>
                                                <bvar><ci>match</ci></bvar>
                                                <bvar><ci>x</ci></bvar>
                                                <bvar><ci>start</ci></bvar>
                                                <apply><and/>
                                                    <ci>match</ci>
                                                    <apply><geq/>
                                                        <ci>x</ci>
                                                        <ci>start</ci>
                                                    </apply>
                                                </apply>
                                            </lambda>
                                            <ci>afterStarts</ci>
                                        </piece>
                                        <otherwise>
                                            <lambda>
                                                <bvar><ci>match</ci></bvar>
                                                <bvar><ci>x</ci></bvar>
                                                <bvar><ci>start</ci></bvar>
                                                <apply><and/>
                                                    <ci>match</ci>
                                                    <apply><leq/>
                                                        <ci>x</ci>
                                                        <ci>start</ci>
                                                    </apply>
                                                </apply>
                                            </lambda>
                                        </otherwise>
                                    </piecewise>
                                    <ci>y_matches</ci>
                                    <ci>xs</ci>
                                    <ci>stretched_starts</ci>
                                </apply>
                            </apply>
                        </apply>
                        <!-- Compute "(xs[i]-xs[i-1]) / (ys[i]-ys[i-1])" (but don't index it yet) -->
                        <apply><eq/>
                            <ci>gradient</ci>
                            <apply>
                                <ci>grad</ci>
                                <ci>ys</ci>
                                <ci>xs</ci>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <!-- Add a zero on the front to make it match xs etc. in size, and handle the i==0 case -->
                        <apply><eq/>
                            <ci>zero_array</ci><!-- Zero array of shape result_shape -->
                            <!-- TODO: better approach? -->
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <lambda>
                                    <bvar><ci>_</ci></bvar>
                                    <cn>0</cn>
                                </lambda>
                                <ci>targets</ci>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>gradient_extended</ci>
                            <apply><ci>join</ci>
                                <piecewise>
                                    <piece><ci>zero_array</ci><ci>afterStarts</ci></piece>
                                    <otherwise><ci>gradient</ci></otherwise>
                                </piecewise>
                                <piecewise>
                                    <piece><ci>gradient</ci><ci>afterStarts</ci></piece>
                                    <otherwise><ci>zero_array</ci></otherwise>
                                </piecewise>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <!-- Compute "(y - ys[i-1])" or "(y - ys[i])" -->
                        <apply><eq/>
                            <ci>shift_dir</ci>
                            <piecewise>
                                <piece><cn>1</cn><ci>afterStarts</ci></piece>
                                <otherwise><cn>0</cn></otherwise>
                            </piecewise>
                        </apply>
                        <apply><eq/>
                            <ci>target_minus_ys</ci>
                            <apply><ci>shift</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">minus</csymbol>
                                    <ci>stretched_targets</ci>
                                    <ci>ys</ci>
                                </apply>
                                <ci>shift_dir</ci>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <!-- Shift xs to get xs[i-1] or xs -->
                        <apply><eq/>
                            <ci>shifted_xs</ci>
                            <apply><ci>shift</ci>
                                <ci>xs</ci><ci>shift_dir</ci><ci>dim</ci>
                            </apply>
                        </apply>
                        <!-- Compute the 'total' result -->
                        <apply><eq/>
                            <ci>result</ci>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/index"/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                    <lambda>
                                        <bvar><ci>shifted_x</ci></bvar>
                                        <bvar><ci>t_minus_y</ci></bvar>
                                        <bvar><ci>x_over_y</ci></bvar>
                                        <apply><plus/>
                                            <ci>shifted_x</ci>
                                            <apply><times/>
                                                <ci>t_minus_y</ci><ci>x_over_y</ci>
                                            </apply>
                                        </apply>
                                    </lambda>
                                    <ci>shifted_xs</ci>
                                    <ci>target_minus_ys</ci>
                                    <ci>gradient_extended</ci>
                                </apply>
                                <ci>idxs</ci>
                                <ci>dim</ci>
                                <piecewise>
                                    <!-- shrink excess off the correct end -->
                                    <piece><cn>1</cn><ci>afterStarts</ci></piece>
                                    <otherwise><cn>-1</cn></otherwise>
                                </piecewise>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                            </apply>
                        </apply>
                        <!-- Finally, take the first/last match... -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                <ci>result</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                    <ci>dim</ci>
                                    <piecewise>
                                        <piece><cn>0</cn><ci>afterStarts</ci></piece>
                                        <otherwise><cn>-1</cn></otherwise>
                                    </piecewise>
                                    <cn>1</cn>
                                    <piecewise>
                                        <piece><cn>1</cn><ci>afterStarts</ci></piece>
                                        <otherwise><csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/></otherwise>
                                    </piecewise>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    <cn>1</cn>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
        </apply>
    </library>
</protocol>
