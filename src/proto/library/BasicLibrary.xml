<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#">
    <post-processing>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!--
                def diff(array, dim=array.num_dims-1):
                    map(-, array[<dim>1:], array[<dim>:-1])
            -->
            <apply><eq/>
                <ci>diff</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                <ci>array</ci>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>default_dim</ci>
                            <apply><minus/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                    <ci>array</ci>
                                </apply>
                                <cn>1</cn>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>dim</ci>
                            <piecewise>
                                <piece>
                                    <ci>default_dim</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_DEFAULT</csymbol>
                                        <ci>dim'</ci>
                                    </apply>
                                </piece>
                                <otherwise>
                                    <ci>dim'</ci>
                                </otherwise>
                            </piecewise>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><lt/>
                                <ci>dim</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                    <ci>array</ci>
                                </apply>
                            </apply>
                        </apply>
                        
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">minus</csymbol>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>array</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>1</cn>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>array</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <cn>1</cn>
                                        <cn>-1</cn>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
        </apply>
    </post-processing>
</protocol>
