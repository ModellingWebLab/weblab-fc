<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#">
    <post-processing>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!-- max = lambda a, dim=default: fold(mathml.max, a, default, dim) -->
            <apply><eq/>
                <ci>max</ci>
                <lambda>
                    <bvar><ci>a</ci></bvar>
                    <semantics>
                        <bvar><ci>dim</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/fold"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">max</csymbol>
                        <ci>a</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        <ci>dim</ci>
                    </apply>
                </lambda>
            </apply>

            <!-- min = lambda a, dim=default: fold(mathml.min, a, default, dim) -->
            <apply><eq/>
                <ci>min</ci>
                <lambda>
                    <bvar><ci>a</ci></bvar>
                    <semantics>
                        <bvar><ci>dim</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/fold"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">min</csymbol>
                        <ci>a</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        <ci>dim</ci>
                    </apply>
                </lambda>
            </apply>
            
            <!-- default_dim(array, dim'): if dim'=default then array.num_dims-1 else dim' -->
            <apply><eq/>
                <ci>default_dim</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>dim'</ci></bvar>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                <ci>array</ci>
                            </apply>
                        </apply>
                        <!-- calculate result -->
                        <apply><eq/>
                            <ci>default_dim</ci>
                            <apply><minus/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                    <ci>array</ci>
                                </apply>
                                <cn>1</cn>
                            </apply>
                        </apply>
                        <apply><eq/>
                            <ci>dim</ci>
                            <piecewise>
                                <piece>
                                    <ci>default_dim</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_DEFAULT</csymbol>
                                        <ci>dim'</ci>
                                    </apply>
                                </piece>
                                <otherwise>
                                    <ci>dim'</ci>
                                </otherwise>
                            </piecewise>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_SIMPLE_VALUE</csymbol>
                                <ci>dim</ci>
                            </apply>
                        </apply>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><lt/>
                                <ci>dim</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                    <ci>array</ci>
                                </apply>
                            </apply>
                        </apply>
                        <!-- return result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <ci>dim</ci>
                        </apply>
                    </apply>
                </lambda>
            </apply>
                        
            <!--
                def diff(array, dim=array.num_dims-1):
                    map(-, array[<dim>1:], array[<dim>:-1])
            -->
            <apply><eq/>
                <ci>diff</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments using default_dim -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply>
                                <ci>default_dim</ci>
                                <ci>array</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">minus</csymbol>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>array</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>1</cn>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>array</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <cn>1</cn>
                                        <cn>-1</cn>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- grad x y [dim] = map (/) (diff y dim) (diff x dim) -->
            <apply><eq/>
                <ci>grad</ci>
                <lambda>
                    <bvar><ci>x</ci></bvar>
                    <bvar><ci>y</ci></bvar>
                    <semantics>
                        <bvar><ci>dim</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">divide</csymbol>
                        <apply>
                            <ci>diff</ci>
                            <ci>y</ci>
                            <ci>dim</ci>
                        </apply>
                        <apply>
                            <ci>diff</ci>
                            <ci>x</ci>
                            <ci>dim</ci>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- join(a1, a2, dim=default): catenate two arrays along the given dimension -->
            <apply><eq/>
                <ci>join</ci>
                <lambda>
                    <bvar><ci>a1</ci></bvar>
                    <bvar><ci>a2</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test some arguments using default_dim -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply>
                                <ci>default_dim</ci>
                                <ci>a1</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- the array comprehension will check that a1.num_dims == a2.num_dims, and that the shapes match up -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                                <domainofapplication>
                                    <!-- #dim#i=-a1.shape[dim]:a2.shape[dim] -->
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <apply><minus/>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                                    <ci>a1</ci>
                                                </apply>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                    <cn>0</cn>
                                                    <ci>dim</ci>
                                                    <cn>0</cn>
                                                    <ci>dim</ci>
                                                </apply>
                                            </apply>
                                        </apply>
                                        <cn>1</cn>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                                <ci>a2</ci>
                                            </apply>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <cn>0</cn>
                                                <ci>dim</ci>
                                                <cn>0</cn>
                                                <ci>dim</ci>
                                            </apply>
                                        </apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">i</csymbol>
                                    </apply>
                                </domainofapplication>
                                <!-- If the index along dim is less than zero, use a slice of a1, else a slice of a2 -->
                                <piecewise>
                                    <piece>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                            <ci>a1</ci>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <ci>dim</ci>
                                                <ci>i</ci>
                                                <cn>0</cn>
                                                <ci>i</ci>
                                            </apply>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                <cn>1</cn>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                            </apply>
                                        </apply>
                                        <apply><lt/><ci>i</ci><cn>0</cn></apply>
                                    </piece>
                                    <otherwise>
                                        <apply>
                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                            <ci>a2</ci>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <ci>dim</ci>
                                                <ci>i</ci>
                                                <cn>0</cn>
                                                <ci>i</ci>
                                            </apply>
                                            <apply>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                <cn>1</cn>
                                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                            </apply>
                                        </apply>
                                    </otherwise>
                                </piecewise>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- stretch(array, length, dim=default): stretch dimension dim (of length 1) to the given length -->
            <apply><eq/>
                <ci>stretch</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>length</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- some testing of arguments using default_dim -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply>
                                <ci>default_dim</ci>
                                <ci>array</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- Also check that the array.shape[dim] == 1 -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply><eq/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                                        <ci>array</ci>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <cn>0</cn>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <ci>dim</ci>
                                    </apply>
                                </apply>
                                <cn>1</cn>
                            </apply>
                        </apply>
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                                <domainofapplication>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <cn>1</cn>
                                        <ci>length</ci>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">i</csymbol>
                                    </apply>
                                </domainofapplication>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <ci>array</ci>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <ci>dim</ci>
                                        <cn>0</cn>
                                        <cn>0</cn>
                                        <cn>0</cn>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- shift(array, distance, dim=default) -->
            <apply><eq/>
                <ci>shift</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>distance</ci></bvar>
                    <semantics>
                        <bvar><ci>dim'</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments using default_dim -->
                        <apply><eq/>
                            <ci>dim</ci>
                            <apply>
                                <ci>default_dim</ci>
                                <ci>array</ci>
                                <ci>dim'</ci>
                            </apply>
                        </apply>
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <piecewise>
                                <piece>
                                    <!-- no-op if distance == 0 -->
                                    <ci>array</ci>
                                    <apply><eq/><ci>distance</ci><cn>0</cn></apply>
                                </piece>
                                <otherwise>
                                    <piecewise>
                                        <piece>
                                            <!-- shift right if distance > 0:
                                                join stretch(array[<dim>0:1], distance, dim)
                                                   & array[<dim>0:-distance] along dim -->
                                            <apply>
                                                <ci>join</ci>
                                                <apply>
                                                    <ci>stretch</ci>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                        <ci>array</ci>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                            <ci>dim</ci>
                                                            <cn>0</cn>
                                                            <cn>1</cn>
                                                            <cn>1</cn>
                                                        </apply>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                            <cn>1</cn>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        </apply>
                                                    </apply>
                                                    <ci>distance</ci>
                                                    <ci>dim</ci>
                                                </apply>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                    <ci>array</ci>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <ci>dim</ci>
                                                        <cn>0</cn>
                                                        <cn>1</cn>
                                                        <apply><minus/><ci>distance</ci></apply>
                                                    </apply>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        <cn>1</cn>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                    </apply>
                                                </apply>
                                                <ci>dim</ci>
                                            </apply>
                                            <apply><gt/><ci>distance</ci><cn>0</cn></apply>
                                        </piece>
                                        <otherwise>
                                            <!-- shift left if distance < 0:
                                                join array[<dim>-distance:]
                                                   & stretch(array[<dim>-1:], -distance, dim) along dim -->
                                            <apply>
                                                <ci>join</ci>
                                                <apply>
                                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                    <ci>array</ci>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <ci>dim</ci>
                                                        <apply><minus/><ci>distance</ci></apply>
                                                        <cn>1</cn>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                    </apply>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        <cn>1</cn>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                    </apply>
                                                </apply>
                                                <apply>
                                                    <ci>stretch</ci>
                                                    <apply>
                                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                                        <ci>array</ci>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                            <ci>dim</ci>
                                                            <cn>-1</cn>
                                                            <cn>1</cn>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        </apply>
                                                        <apply>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                            <cn>1</cn>
                                                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                                        </apply>
                                                    </apply>
                                                    <apply><minus/><ci>distance</ci></apply>
                                                    <ci>dim</ci>
                                                </apply>
                                                <ci>dim</ci>
                                            </apply>
                                        </otherwise>
                                    </piecewise>
                                </otherwise>
                            </piecewise>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- window(array, size, dim=default) -->
            <apply><eq/>
                <ci>window</ci>
                <lambda>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>size</ci></bvar>
                    <semantics>
                        <bvar><ci>dim</ci></bvar>
                        <annotation-xml>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                        </annotation-xml>
                    </semantics>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
                        <!-- test arguments -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                                <ci>array</ci>
                            </apply>
                        </apply>
                        
                        <!-- calculate result -->
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/return"/>
                            <apply>
                                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                                <domainofapplication>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <cn>0</cn> <!-- dim -->
                                        <apply><minus/><ci>size</ci></apply> <!-- start -->
                                        <cn>1</cn> <!-- stride -->
                                        <apply><plus/><ci>size</ci><cn>1</cn></apply> <!-- end -->
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">i</csymbol> <!-- var name -->
                                    </apply>
                                </domainofapplication>
                                <apply>
                                    <ci>shift</ci>
                                    <ci>array</ci>
                                    <ci>i</ci>
                                    <ci>dim</ci>
                                </apply>
                            </apply>
                        </apply>
                    </apply>
                </lambda>
            </apply>
            
            <!-- Recursive function to fold along every dimension in turn, starting from zero -->
            <apply><eq/>
                <ci>multi_fold</ci>
                <lambda>
                    <bvar><ci>op</ci></bvar>
                    <bvar><ci>array</ci></bvar>
                    <bvar><ci>init</ci></bvar>
                    <piecewise>
                        <piece>
                            <!-- Base case: 0d input - return the single value -->
                            <ci>array</ci>
                            <apply><eq/>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                                    <ci>array</ci>
                                </apply>
                                <cn>0</cn>
                            </apply>
                        </piece>
                        <otherwise>
                            <!-- Recursive case: fold zeroth dimension -->
                            <apply>
                                <ci>multi_fold</ci>
                                <ci>op</ci>
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/fold"/>
                                        <ci>op</ci>
                                        <ci>array</ci>
                                        <ci>init</ci>
                                        <cn>0</cn>
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <cn>0</cn> <!-- dim -->
                                        <cn>0</cn> <!-- start -->
                                        <cn>0</cn> <!-- stride -->
                                        <cn>0</cn> <!-- end -->
                                    </apply>
                                    <apply>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                        <cn>1</cn>
                                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                                    </apply>
                                </apply>
                                <ci>init</ci>
                            </apply>                            
                        </otherwise>
                    </piecewise>
                </lambda>
            </apply>

            <!-- Function to check array equality elementwise.
                Works with arrays of any dimension.
                Implemented as multi_fold(and, map(eq, a1, a2), true) -->
            <apply><eq/>
                <ci>array_eq</ci>
                <lambda>
                    <bvar><ci>a1</ci></bvar>
                    <bvar><ci>a2</ci></bvar>
                    <apply>
                        <ci>multi_fold</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">and</csymbol>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">eq</csymbol>
                            <ci>a1</ci>
                            <ci>a2</ci>
                        </apply>
                        <cn>1</cn>
                    </apply>
                </lambda>
            </apply>
            
        </apply>
    </post-processing>
</protocol>
