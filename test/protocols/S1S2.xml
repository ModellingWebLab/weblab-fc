<?xml version="1.0"?>
<?xml-model href="../../src/proto/parsing/protocol.rnc" type="application/relax-ng-compact-syntax"?>
<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#">
    <!-- Declare protocol inputs with default values -->
    <inputs>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            <apply><eq/>
                <ci>s1_interval</ci>
                <cn>1000</cn>
            </apply>
            <apply><eq/>
                <ci>steady_state_beats</ci>
                <cn>1000</cn>
            </apply>
            <apply><eq/>
                <ci>timecourse_duration</ci>
                <cn>3000</cn>
            </apply>
            <apply><eq/>
                <ci>s2_intervals</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                    <cn>2000</cn><cn>1950</cn><cn>1900</cn><cn>1850</cn><cn>1800</cn><cn>1750</cn><cn>1700</cn><cn>1650</cn><cn>1600</cn><cn>1550</cn>
                    <cn>1500</cn><cn>1450</cn><cn>1400</cn><cn>1350</cn><cn>1300</cn><cn>1250</cn><cn>1200</cn><cn>1150</cn><cn>1100</cn><cn>1050</cn><cn>1000</cn>
                    <cn>975</cn><cn>950</cn><cn>925</cn><cn>900</cn>
                    <cn>875</cn><cn>850</cn><cn>825</cn><cn>800</cn>
                    <cn>775</cn><cn>750</cn><cn>725</cn><cn>700</cn>
                    <cn>680</cn><cn>660</cn><cn>640</cn><cn>620</cn><cn>600</cn>
                    <cn>580</cn><cn>560</cn><cn>540</cn><cn>520</cn><cn>500</cn>
                    <cn>490</cn><cn>480</cn><cn>470</cn><cn>460</cn><cn>450</cn><cn>440</cn><cn>430</cn><cn>420</cn><cn>410</cn><cn>400</cn>
                    <cn>390</cn><cn>380</cn><cn>370</cn><cn>360</cn><cn>350</cn><cn>340</cn><cn>330</cn><cn>320</cn><cn>310</cn><cn>300</cn>
                    <cn>290</cn><cn>280</cn><cn>270</cn><cn>260</cn><cn>250</cn><cn>240</cn><cn>230</cn><cn>220</cn><cn>210</cn><cn>200</cn>
                    <cn>190</cn><cn>180</cn><cn>170</cn><cn>160</cn><cn>150</cn><cn>140</cn><cn>130</cn><cn>120</cn><cn>110</cn><cn>100</cn>
                    <cn>90</cn> <cn>80</cn> <cn>70</cn> <cn>60</cn> <cn>50</cn> <cn>40</cn> <cn>30</cn> <cn>20</cn>
                </apply>
            </apply>
        </apply>    
    </inputs>
    
    <modelModification><![CDATA[
doc._cml_config.options.convert_interfaces = True
p = protocol.Protocol(doc.model, multi_stage=True)
V = doc.model.get_variable_by_oxmeta_name('membrane_voltage')
t = doc.model.get_variable_by_oxmeta_name('time')

pending = []

def maybe_new_var(name, units, init):
    try:
        v = doc.model.get_variable_by_oxmeta_name(name)
    except:
        v = None
    if v:
        v = p.specify_as_input(v, units)
        v.initial_value = init
    else:
        units = p.add_units(units)
        v = protocol.cellml_variable.create_new(doc.model, name, units.name, initial_value=init, id=name)
        pending.append((v, name))
        p.inputs.add(v)
    return v
new_var = lambda name, units, init: protocol.cellml_variable.create_new(doc.model, name, units, initial_value=init, id=name)
new_apply = lambda op, args: protocol.mathml_apply.create_new(doc, op, args)
def vn(v):
    if getattr(v, 'xml_parent', None):
        return v.component.name + u',' + v.name
    else:
        return u'protocol,' + v.name

ms = protocol.cellml_units.create_new(doc.model, u'ms', [{'units':'second', 'prefix':'milli'}])
p.inputs.add(ms)
i_stim = doc.model.get_variable_by_oxmeta_name('membrane_stimulus_current')
i_stim_amp = doc.model.get_variable_by_oxmeta_name('membrane_stimulus_current_amplitude')
i_stim_duration = doc.model.get_variable_by_oxmeta_name('membrane_stimulus_current_duration')
stim_end = maybe_new_var(u'membrane_stimulus_current_end', ms, u'100000000000')
stim_offset = maybe_new_var(u'membrane_stimulus_current_offset', ms, u'10')
stim_period = maybe_new_var(u'membrane_stimulus_current_period', ms, u'1000')
start = new_apply('geq', [vn(t), vn(stim_offset)])
stop = new_apply('leq', [vn(t), vn(stim_end)])
during = new_apply('leq',
                   [new_apply('minus',
                              [new_apply('minus', [vn(t), vn(stim_offset)]),
                               new_apply('times',
                                         [new_apply('floor',
                                                    [new_apply('divide',
                                                               [new_apply('minus', [vn(t), vn(stim_offset)]),
                                                                vn(stim_period)])]),
                                          vn(stim_period)])]),
                    vn(i_stim_duration)])
cond = new_apply(u'and', [start, stop, during])
if i_stim_amp.get_value() < 0:
    case = protocol.mathml_ci.create_new(doc, vn(i_stim_amp))
else:
    case = new_apply('minus', [vn(i_stim_amp)])
otherwise = protocol.mathml_cn.create_new(doc, u'0', i_stim_amp.units)
i_stim_defn = new_apply(u'eq', [vn(i_stim), protocol.mathml_piecewise.create_new(doc, [(case, cond)], otherwise)])

p.outputs = [V, t]
p.inputs.add(i_stim_defn)
p.modify_model()

for v, name in pending:
    v.set_oxmeta_name(name)
]]></modelModification>
    
    <simulations>
        <!-- Do a pre-run to get the model to steady-state with the desired S1 stimulus -->
        <timecourseSimulation>
            <vectorStepper name="time" units="ms">
                <value>0</value>
                <apply xmlns="http://www.w3.org/1998/Math/MathML"><times/>
                    <ci>s1_interval</ci>
                    <ci>steady_state_beats</ci>
                </apply>
            </vectorStepper>
            <modifiers>
                <!-- Set stimulus period to S1 interval, offset 10ms -->                    
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>membrane_stimulus_current_period</name><!-- ms -->
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">s1_interval</ci>
                    </value>
                </setVariable>                 
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>membrane_stimulus_current_offset</name><!-- ms -->
                    <value>
                        <cn xmlns="http://www.w3.org/1998/Math/MathML">10</cn>
                    </value>
                </setVariable>
                <saveState>
                    <when>AT_END</when>
                    <name>initial_state</name>
                </saveState>
            </modifiers>
        </timecourseSimulation>
        
        <!-- Now do the S1-S2 part, i.e. two stimuli -->
        <nestedSimulation>
            <vectorStepper name="s2_interval" units="dimensionless">
                <ci xmlns="http://www.w3.org/1998/Math/MathML">s2_intervals</ci>
            </vectorStepper>
            <modifiers>
                <resetState>
                    <when>EVERY_LOOP</when>
                    <state>initial_state</state>
                </resetState>
                <!-- Set the gap between stimuli to the S2 interval -->
                <setVariable>
                    <when>EVERY_LOOP</when>
                    <name>membrane_stimulus_current_period</name>
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">s2_interval</ci>
                    </value>
                </setVariable>
                <!-- And only do one S2 stimulus -->
                <setVariable>
                    <when>EVERY_LOOP</when>
                    <name>membrane_stimulus_current_end</name>
                    <value>
                        <apply xmlns="http://www.w3.org/1998/Math/MathML"><times/>
                            <ci>s2_interval</ci>
                            <cn>1.5</cn>
                        </apply>
                    </value>
                </setVariable>
            </modifiers>
            <timecourseSimulation>
                <uniformStepper name="time" units="ms">
                    <start>0</start>
                    <stop><ci xmlns="http://www.w3.org/1998/Math/MathML">timecourse_duration</ci></stop>
                    <step>1</step>
                </uniformStepper>
                <modifiers/>
            </timecourseSimulation>
        </nestedSimulation>
    </simulations>
    
    <post-processing>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!-- Test that expected model outputs exist -->
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>time</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>membrane_voltage</ci>
                </apply>
            </apply>
            
            <!-- Compute APD90 -->
            <apply><eq/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                    <ci>raw_APD90</ci>
                    <ci>raw_DI</ci>
                </apply>
                <apply><ci>apd</ci>
                    <ci>membrane_voltage</ci>
                    <ci>time</ci>
                    <cn>90</cn>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            
            <!-- Just consider the first DI and the second AP to be of interest -->
            <apply><eq/>
                <ci>first_raw_DI</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                    <ci>raw_DI</ci>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <cn>1</cn><cn>0</cn><cn>0</cn><cn>0</cn>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <cn>1</cn>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                    </apply>
                </apply>
            </apply>
            <apply><eq/>
                <ci>second_raw_APD</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                    <ci>raw_APD90</ci>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <cn>1</cn><cn>1</cn><cn>0</cn><cn>1</cn>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <cn>1</cn>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                    </apply>
                </apply>
            </apply>
            
            <!--
                Remove entries for negative DIs from both the DI and APD arrays.
                This removes entries where the S2 stimulus was applied before repolarisation from the last S1 pulse.
                Also ignore entries with DI <= 19ms (which tend to skew the graph scales).
            -->
            <apply><eq/>
                <ci>min_DI</ci>
                <cn>19</cn>
            </apply>
            <apply><eq/>
                <ci>DI</ci>
                <apply><ci>after</ci>
                    <ci>first_raw_DI</ci>
                    <ci>first_raw_DI</ci>
                    <ci>min_DI</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            <apply><eq/>
                <ci>APD90</ci>
                <apply><ci>after</ci>
                    <ci>second_raw_APD</ci>
                    <ci>first_raw_DI</ci>
                    <ci>min_DI</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>

            <!-- Calculate slope information -->
            <apply><eq/>
                <ci>S1S2_slope</ci>
                <apply><ci>grad</ci>
                    <ci>DI</ci>
                    <ci>APD90</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            <apply><eq/>
                <ci>max_S1S2_slope</ci>
                <apply><ci>max</ci>
                    <ci>S1S2_slope</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
        </apply>
    </post-processing>
    
    <outputVariables>
        <model name="membrane_voltage" description="Transmembrane potential"/>
        <postprocessed name="raw_APD90" units="ms"/>
        <postprocessed name="raw_DI" units="ms"/>
        <postprocessed name="APD90" units="ms" description="Action Potential Duration (at 90%)"/>
        <postprocessed name="DI" units="ms" description="Diastolic Interval"/>
        <postprocessed name="S1S2_slope" units="dimensionless" description="S1-S2 curve gradient"/>
        <postprocessed name="max_S1S2_slope" units="dimensionless" description="Maximum gradient of S1-S2 curve"/>
    </outputVariables>
    
    <plots>
        <plot>
            <title>S1-S2 curve</title>
            <x>DI</x>
            <y>APD90</y>
        </plot>
        <plot>
            <title>Transmembrane potential traces</title>
            <data>membrane_voltage</data>
        </plot>
    </plots>
</protocol>
