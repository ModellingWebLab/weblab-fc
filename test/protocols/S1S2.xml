<?xml version="1.0"?>
<?xml-model href="../../src/proto/parsing/protocol.rnc" type="application/relax-ng-compact-syntax"?>
<?oxygen RNGSchema="../../src/proto/parsing/protocol.rnc" type="compact"?>
<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#"
    xmlns:proto="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#"
    xmlns:cellml="http://www.cellml.org/cellml/1.0#"
    xmlns:oxmeta="https://chaste.comlab.ox.ac.uk/cellml/ns/oxford-metadata#">
    <!-- Declare protocol inputs with default values -->
    <inputs>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            <apply><eq/>
                <ci>s1_interval</ci>
                <cn>1000</cn>
            </apply>
            <apply><eq/>
                <ci>steady_state_beats</ci>
                <cn>1000</cn>
            </apply>
            <apply><eq/>
                <ci>timecourse_duration</ci>
                <cn>3000</cn>
            </apply>
            <apply><eq/>
                <ci>s2_intervals</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                    <cn>2000</cn><cn>1950</cn><cn>1900</cn><cn>1850</cn><cn>1800</cn><cn>1750</cn><cn>1700</cn><cn>1650</cn><cn>1600</cn><cn>1550</cn>
                    <cn>1500</cn><cn>1450</cn><cn>1400</cn><cn>1350</cn><cn>1300</cn><cn>1250</cn><cn>1200</cn><cn>1150</cn><cn>1100</cn><cn>1050</cn><cn>1000</cn>
                    <cn>975</cn><cn>950</cn><cn>925</cn><cn>900</cn>
                    <cn>875</cn><cn>850</cn><cn>825</cn><cn>800</cn>
                    <cn>775</cn><cn>750</cn><cn>725</cn><cn>700</cn>
                    <cn>680</cn><cn>660</cn><cn>640</cn><cn>620</cn><cn>600</cn>
                    <cn>580</cn><cn>560</cn><cn>540</cn><cn>520</cn><cn>500</cn>
                    <cn>490</cn><cn>480</cn><cn>470</cn><cn>460</cn><cn>450</cn><cn>440</cn><cn>430</cn><cn>420</cn><cn>410</cn><cn>400</cn>
                    <cn>390</cn><cn>380</cn><cn>370</cn><cn>360</cn><cn>350</cn><cn>340</cn><cn>330</cn><cn>320</cn><cn>310</cn><cn>300</cn>
                    <cn>290</cn><cn>280</cn><cn>270</cn><cn>260</cn><cn>250</cn><cn>240</cn><cn>230</cn><cn>220</cn><cn>210</cn><cn>200</cn>
                    <cn>190</cn><cn>180</cn><cn>170</cn><cn>160</cn><cn>150</cn><cn>140</cn><cn>130</cn><cn>120</cn><cn>110</cn><cn>100</cn>
                    <cn>90</cn> <cn>80</cn> <cn>70</cn> <cn>60</cn> <cn>50</cn> <cn>40</cn> <cn>30</cn> <cn>20</cn>
                </apply>
            </apply>
        </apply>    
    </inputs>
    
    <import source="BasicLibrary.xml" mergeDefinitions="true"/>
    <import source="CardiacLibrary.xml" mergeDefinitions="true"/>
    
    <units>
        <cellml:units name="mV">
            <cellml:unit units="volt" prefix="milli"/>
        </cellml:units>
        <cellml:units name="ms">
            <cellml:unit units="second" prefix="milli"/>
        </cellml:units>
    </units>
    
    <modelInterface>
        <specifyInputVariable name="oxmeta:membrane_stimulus_current_end" units="ms" initial_value="100000000000"/>
        <specifyInputVariable name="oxmeta:membrane_stimulus_current_offset" units="ms" initial_value="10"/>
        <specifyInputVariable name="oxmeta:membrane_stimulus_current_period" units="ms" initial_value="1000"/>
        <specifyOutputVariable name="oxmeta:membrane_voltage" units="mV"/>
        <specifyOutputVariable name="oxmeta:time" units="ms"/>
        
        <addOrReplaceEquation>
            <apply xmlns="http://www.w3.org/1998/Math/MathML"><eq/>
                <ci>oxmeta:membrane_stimulus_current</ci>
                <piecewise>
                    <piece>
                        <ci>oxmeta:membrane_stimulus_current_amplitude</ci>
                        <apply><and/>
                            <apply><geq/>
                                <ci>oxmeta:time</ci>
                                <ci>oxmeta:membrane_stimulus_current_offset</ci>
                            </apply>
                            <apply><leq/>
                                <ci>oxmeta:time</ci>
                                <ci>oxmeta:membrane_stimulus_current_end</ci>
                            </apply>
                            <apply><leq/>
                                <apply><minus/>
                                    <apply><minus/>
                                        <ci>oxmeta:time</ci>
                                        <ci>oxmeta:membrane_stimulus_current_offset</ci>
                                    </apply>
                                    <apply><times/>
                                        <apply><floor/>
                                            <apply><divide/>
                                                <apply><minus/>
                                                    <ci>oxmeta:time</ci>
                                                    <ci>oxmeta:membrane_stimulus_current_offset</ci>
                                                </apply>
                                                <ci>oxmeta:membrane_stimulus_current_period</ci>
                                            </apply>
                                        </apply>
                                        <ci>oxmeta:membrane_stimulus_current_period</ci>
                                    </apply>
                                </apply>
                                <ci>oxmeta:membrane_stimulus_current_duration</ci>
                            </apply>
                        </apply>
                    </piece>
                    <otherwise>
                        <apply><times/>
                            <cn cellml:units="dimensionless">0</cn>
                            <ci>oxmeta:membrane_stimulus_current_amplitude</ci>
                        </apply>
                    </otherwise>
                </piecewise>
            </apply>
        </addOrReplaceEquation>
    </modelInterface>
    
    <simulations>
        <!-- Do a pre-run to get the model to steady-state with the desired S1 stimulus -->
        <timecourseSimulation>
            <vectorStepper name="time" units="ms">
                <value>0</value>
                <apply xmlns="http://www.w3.org/1998/Math/MathML"><times/>
                    <ci>s1_interval</ci>
                    <ci>steady_state_beats</ci>
                </apply>
            </vectorStepper>
            <modifiers>
                <!-- Set stimulus period to S1 interval, offset 10ms -->                    
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:membrane_stimulus_current_period</name><!-- ms -->
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">s1_interval</ci>
                    </value>
                </setVariable>                 
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:membrane_stimulus_current_offset</name><!-- ms -->
                    <value>
                        <cn xmlns="http://www.w3.org/1998/Math/MathML">10</cn>
                    </value>
                </setVariable>
                <saveState>
                    <when>AT_END</when>
                    <name>initial_state</name>
                </saveState>
            </modifiers>
        </timecourseSimulation>
        
        <!-- Now do the S1-S2 part, i.e. two stimuli -->
        <nestedSimulation prefix="sim">
            <vectorStepper name="s2_interval" units="dimensionless">
                <ci xmlns="http://www.w3.org/1998/Math/MathML">s2_intervals</ci>
            </vectorStepper>
            <modifiers>
                <resetState>
                    <when>EVERY_LOOP</when>
                    <state>initial_state</state>
                </resetState>
                <!-- Set the gap between stimuli to the S2 interval -->
                <setVariable>
                    <when>EVERY_LOOP</when>
                    <name>oxmeta:membrane_stimulus_current_period</name>
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">s2_interval</ci>
                    </value>
                </setVariable>
                <!-- And only do one S2 stimulus -->
                <setVariable>
                    <when>EVERY_LOOP</when>
                    <name>oxmeta:membrane_stimulus_current_end</name>
                    <value>
                        <apply xmlns="http://www.w3.org/1998/Math/MathML"><times/>
                            <ci>s2_interval</ci>
                            <cn>1.5</cn>
                        </apply>
                    </value>
                </setVariable>
            </modifiers>
            <timecourseSimulation>
                <uniformStepper name="time" units="ms">
                    <start>0</start>
                    <stop><ci xmlns="http://www.w3.org/1998/Math/MathML">timecourse_duration</ci></stop>
                    <step>1</step>
                </uniformStepper>
                <modifiers/>
            </timecourseSimulation>
        </nestedSimulation>
    </simulations>
    
    <post-processing>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!-- Test that expected model outputs exist -->
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim:time</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim:membrane_voltage</ci>
                </apply>
            </apply>
            
            <!-- Get out a single 1D array for time (for plotting) -->
            <apply><eq/>
                <ci>time_1d</ci>
                <apply><ci>RemoveDim</ci>
                     <ci>sim:time</ci>     
                     <cn>0</cn>
                </apply>
            </apply>
            
            <!-- Compute APD90 -->
            <apply><eq/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                    <ci>raw_APD90</ci>
                    <ci>raw_DI</ci>
                </apply>
                <apply><ci>ApdAndDi</ci>
                    <ci>sim:membrane_voltage</ci>
                    <ci>sim:time</ci>
                    <cn>90</cn>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            
            <!-- Just consider the first DI and the second AP to be of interest -->
            <apply><eq/>
                <ci>first_raw_DI</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                    <ci>raw_DI</ci>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <cn>1</cn>
                        <cn>0</cn>
                        <cn>0</cn>
                        <cn>0</cn>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <cn>1</cn>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                    </apply>
                </apply>
            </apply>
            <apply><eq/>
                <ci>second_raw_APD</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                    <ci>raw_APD90</ci>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <cn>1</cn>
                        <cn>1</cn>
                        <cn>0</cn>
                        <cn>1</cn>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <cn>1</cn>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                    </apply>
                </apply>
            </apply>
            
            <!--
                Remove entries for negative DIs from both the DI and APD arrays.
                This removes entries where the S2 stimulus was applied before repolarisation from the last S1 pulse.
                Also ignore entries with DI <= 19ms (which tend to skew the graph scales).
            -->
            <apply><eq/>
                <ci>min_DI</ci>
                <cn>19</cn>
            </apply>
            <apply><eq/>
                <ci>DI</ci>
                <apply><ci>After</ci>
                    <ci>first_raw_DI</ci>
                    <ci>first_raw_DI</ci>
                    <ci>min_DI</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            <apply><eq/>
                <ci>APD90</ci>
                <apply><ci>After</ci>
                    <ci>second_raw_APD</ci>
                    <ci>first_raw_DI</ci>
                    <ci>min_DI</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>

            <!-- Calculate slope information -->
            <apply><eq/>
                <ci>S1S2_slope</ci>
                <apply><ci>Grad</ci>
                    <ci>DI</ci>
                    <ci>APD90</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            <apply><eq/>
                <ci>max_S1S2_slope</ci>
                <apply><ci>Max</ci>
                    <ci>S1S2_slope</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
        </apply>
    </post-processing>
    
    <outputVariables>
        <raw ref="sim:membrane_voltage" name="membrane_voltage" description="Transmembrane potential"/>
        <postprocessed name="time_1d" description="Time" units="ms"/>
        <postprocessed name="raw_APD90" units="ms"/>
        <postprocessed name="raw_DI" units="ms"/>
        <postprocessed name="APD90" units="ms" description="Action Potential Duration 90%"/>
        <postprocessed name="DI" units="ms" description="Diastolic Interval"/>
        <postprocessed name="S1S2_slope" units="dimensionless" description="S1-S2 curve gradient"/>
        <postprocessed name="max_S1S2_slope" units="dimensionless" description="Maximum gradient of S1-S2 curve"/>
    </outputVariables>
    
    <plots>
        <plot>
            <title>S1-S2 curve</title>
            <x>DI</x>
            <y>APD90</y>
            <using>linespoints</using>
        </plot>
        <plot>
            <title>Action potential traces</title>
            <x>time_1d</x>
            <y>membrane_voltage</y>
            <using>lines</using>
        </plot>
    </plots>
</protocol>
