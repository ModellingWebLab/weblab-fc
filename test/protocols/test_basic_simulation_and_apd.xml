<?xml version="1.0"?>
<?xml-model href="../../src/proto/parsing/protocol.rnc" type="application/relax-ng-compact-syntax"?>
<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#"
    xmlns:oxmeta="https://chaste.comlab.ox.ac.uk/cellml/ns/oxford-metadata#">
    <import source="../../src/proto/library/BasicLibrary.xml" mergeDefinitions="true"/>
    <import source="../../src/proto/library/CardiacLibrary.xml" mergeDefinitions="true"/>
    <library>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            <apply><eq/>
                <ci>bcl</ci>
                <cn>600.0</cn>
            </apply>
        </apply>
    </library>
    <simulations>
        <nestedSimulation prefix="sim1">
            <vectorStepper name="run_outer" units="dimensionless">
                <value>0</value>
                <value>1</value>
                <value>2</value>
            </vectorStepper>
            <modifiers>
                <saveState>
                    <when>AT_START_ONLY</when>
                    <name>initial_state</name>
                </saveState>
                <!-- Set stimulus: we need 2 APs to be able to calculate a DI -->                    
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:membrane_stimulus_current_amplitude</name><!-- uA/cm^2 -->
                    <value>
                        <cn xmlns="http://www.w3.org/1998/Math/MathML">-25.5</cn>
                    </value>
                </setVariable>
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:membrane_stimulus_current_duration</name><!-- ms -->
                    <value>
                        <cn xmlns="http://www.w3.org/1998/Math/MathML">2.0</cn>
                    </value>
                </setVariable>
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:membrane_stimulus_current_offset</name><!-- ms -->
                    <value>
                        <cn xmlns="http://www.w3.org/1998/Math/MathML">50.0</cn>
                    </value>
                </setVariable>
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:membrane_stimulus_current_period</name><!-- ms -->
                    <value>
                        <!-- Let's prove we can access the stepper -->
                        <apply xmlns="http://www.w3.org/1998/Math/MathML"><plus/>
                            <ci>bcl</ci>
                            <apply><times/>
                                <ci>run_outer</ci>
                                <cn>0</cn>
                            </apply>
                        </apply>
                    </value>
                </setVariable>
            </modifiers>
            <nestedSimulation>
                <uniformStepper name="run_inner" units="dimensionless">
                    <start>0</start>
                    <stop>2</stop>
                    <step>1</step>
                </uniformStepper>
                <modifiers>
                    <!-- Let's prove we can access the outer stepper -->
                    <setVariable>
                        <when>AT_START_ONLY</when>
                        <name>oxmeta:membrane_stimulus_current_period</name><!-- ms -->
                        <value>
                            <apply xmlns="http://www.w3.org/1998/Math/MathML"><plus/>
                                <ci>bcl</ci>
                                <apply><times/>
                                    <ci>run_outer</ci>
                                    <cn>0</cn>
                                </apply>
                            </apply>
                        </value>
                    </setVariable>
                </modifiers>
                <timecourseSimulation>
                    <uniformStepper name="time" units="ms">
                        <start>0</start>
                        <stop>
                            <apply xmlns="http://www.w3.org/1998/Math/MathML"><times/>
                                <ci>bcl</ci>
                                <cn>2</cn>
                            </apply>
                        </stop>
                        <step>1</step>
                    </uniformStepper>
                    <modifiers>
                        <resetState>
                            <when>AT_START_ONLY</when>
                            <state>initial_state</state>
                        </resetState>
                        <saveState>
                            <when>AT_END</when>
                            <name>final_state</name>
                        </saveState>
                    </modifiers>
                </timecourseSimulation>
            </nestedSimulation>
        </nestedSimulation>
        
        <nestedSimulation prefix="sim2">
            <uniformStepper name="run" units="dimensionless">
                <start>0</start>
                <stop>4</stop>
                <step>1</step>
            </uniformStepper>
            <modifiers>
                <resetState>
                    <when>EVERY_LOOP</when>
                </resetState>
            </modifiers>
            <timecourseSimulation>
                <uniformStepper name="time" units="ms">
                    <start>0</start>
                    <stop>1200</stop>
                    <step>1</step>
                </uniformStepper>
                <modifiers/>
            </timecourseSimulation>
        </nestedSimulation>
    </simulations>
    
    <post-processing>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!-- Test that expected model outputs exist -->
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim2:FonRT</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim2:environment_time</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim2:fast_sodium_current__V</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim2:membrane_fast_sodium_current_conductance</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim2:membrane_voltage</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply><eq/>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                        <ci>sim2:membrane_voltage</ci>
                    </apply>
                    <cn>2</cn>
                </apply>
            </apply>
            
            <!-- And check we can access results from multiple simulations -->
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim1:membrane_voltage</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply><eq/>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">NUM_DIMS</csymbol>
                        <ci>sim1:membrane_voltage</ci>
                    </apply>
                    <cn>3</cn>
                </apply>
            </apply>

            <!-- min(time) should all be zero -->
            <apply><eq/>
                <ci>min_time</ci>
                <apply><ci>Min</ci>
                    <ci>sim2:environment_time</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply><eq/>
                    <cn>0</cn>
                    <apply><ci>MultiFold</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">max</csymbol>
                        <ci>min_time</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    </apply>
                </apply>
            </apply>
            
            <!-- apd(fast_sodium_current__V, time) -->
            <apply><eq/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                    <ci>apd90</ci>
                    <ci>di</ci>
                </apply>
                <apply><ci>ApdAndDi</ci>
                    <ci>sim2:fast_sodium_current__V</ci>
                    <ci>sim2:environment_time</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>apd90</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>di</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply><ci>ArrayEq</ci>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                        <ci>apd90</ci>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                        <cn>5</cn>
                        <cn>2</cn>
                    </apply>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply><ci>ArrayEq</ci>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                        <ci>di</ci>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                        <cn>5</cn>
                        <cn>1</cn>
                    </apply>
                </apply>
            </apply>

            <!-- TODO: write utility TS_ASSERT_DELTA equiv. -->
            <!-- All APD90 = 337.123 -->
            <!-- All DI = 262.877 -->
        </apply>            
    </post-processing>

    <outputVariables>
        <raw ref="sim2:membrane_voltage" name="membrane_voltage"/>
        <postprocessed name="apd90" units="ms"/>
        <postprocessed name="di" units="ms" description="Diastolic interval"/>
    </outputVariables>
    
    <plots>
        <plot>
            <title>Pretend S1-S2 curve</title>
            <x>di</x>
            <y>apd90</y>
        </plot>
        <plot>
            <title>Transmembrane potential traces</title>
            <data>membrane_voltage</data>
        </plot>
    </plots>
</protocol>
