<?xml version="1.0"?>
<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#">
    <simulations>
        <nestedSimulation>
            <vectorStepper name="run_outer" units="dimensionless">
                <value>0</value>
                <value>1</value>
                <value>2</value>
            </vectorStepper>
            <modifiers>
                <saveState>
                    <when>AT_START_ONLY</when>
                    <name>initial_state</name>
                </saveState>
            </modifiers>
            <nestedSimulation>
                <uniformStepper name="run_inner" units="dimensionless">
                    <start>0</start>
                    <stop>2</stop>
                    <step>1</step>
                </uniformStepper>
                <modifiers/>
                <timecourseSimulation>
                    <uniformStepper name="time" units="ms">
                        <start>0</start>
                        <stop>1200</stop>
                        <step>1</step>
                    </uniformStepper>
                    <modifiers>
                        <resetModifier>
                            <when>AT_START_ONLY</when>
                            <state>initial_state</state>
                        </resetModifier>
                        <saveState>
                            <when>AT_END</when>
                            <name>final_state</name>
                        </saveState>
                    </modifiers>
                </timecourseSimulation>
            </nestedSimulation>
        </nestedSimulation>
        
        <nestedSimulation>
            <uniformStepper name="run" units="dimensionless">
                <start>0</start>
                <stop>4</stop>
                <step>1</step>
            </uniformStepper>
            <modifiers>
                <resetModifier>
                    <when>EVERY_LOOP</when>
                </resetModifier>
            </modifiers>
            <timecourseSimulation>
                <uniformStepper name="time" units="ms">
                    <start>0</start>
                    <stop>1200</stop>
                    <step>1</step>
                </uniformStepper>
                <modifiers/>
            </timecourseSimulation>
        </nestedSimulation>
    </simulations>
    
    <post-processing>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!-- Test that expected model outputs exist -->
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>FonRT</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>time</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>fast_sodium_current__V</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>membrane_fast_sodium_current_conductance</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>membrane_voltage</ci>
                </apply>
            </apply>

            <!-- min(time) should all be zero -->
            <apply><eq/>
                <ci>min_time</ci>
                <apply><ci>min</ci>
                    <ci>time</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply><eq/>
                    <cn>0</cn>
                    <apply><ci>multi_fold</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/wrap/2">max</csymbol>
                        <ci>min_time</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    </apply>
                </apply>
            </apply>
            
            <!-- apd(fast_sodium_current__V, time) -->
            <apply><eq/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                    <ci>apd90</ci>
                    <ci>di</ci>
                </apply>
                <apply><ci>apd</ci>
                    <ci>fast_sodium_current__V</ci>
                    <ci>time</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>apd90</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>di</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply><ci>array_eq</ci>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                        <ci>apd90</ci>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                        <cn>5</cn>
                        <cn>2</cn>
                    </apply>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply><ci>array_eq</ci>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">SHAPE</csymbol>
                        <ci>di</ci>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                        <cn>5</cn>
                        <cn>1</cn>
                    </apply>
                </apply>
            </apply>

            <!-- TODO: write utility TS_ASSERT_DELTA equiv. -->
            <!-- All APD90 = 337.123 -->
            <!-- All DI = 262.877 -->
        </apply>            
    </post-processing>

    <outputVariables>
        <name>apd90</name>
        <name>di</name>
    </outputVariables>
</protocol>
